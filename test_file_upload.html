<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IM系统 - 文件上传测试</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .upload-area {
        border: 2px dashed #ddd;
        border-radius: 10px;
        padding: 40px;
        text-align: center;
        margin: 20px 0;
        transition: all 0.3s ease;
      }
      .upload-area:hover {
        border-color: #007bff;
        background-color: #f8f9fa;
      }
      .upload-area.dragover {
        border-color: #007bff;
        background-color: #e3f2fd;
      }
      input[type="file"] {
        margin: 10px 0;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #0056b3;
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .result {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
        display: none;
      }
      .success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
      }
      .error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }
      .file-info {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
      }
      .progress {
        width: 100%;
        height: 20px;
        background: #f0f0f0;
        border-radius: 10px;
        overflow: hidden;
        margin: 10px 0;
      }
      .progress-bar {
        height: 100%;
        background: #007bff;
        width: 0%;
        transition: width 0.3s ease;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>📁 IM系统文件上传测试</h1>
      <p>测试文件上传功能，支持图片、文档等多种格式</p>

      <div class="upload-area" id="uploadArea">
        <h3>拖拽文件到此处或点击选择文件</h3>
        <input
          type="file"
          id="fileInput"
          multiple
          accept="image/*,.pdf,.doc,.docx,.txt,.zip,.rar"
        />
        <br />
        <button onclick="document.getElementById('fileInput').click()">
          选择文件
        </button>
        <button onclick="uploadFiles()" id="uploadBtn" disabled>
          上传文件
        </button>
      </div>

      <div class="progress" id="progressContainer" style="display: none">
        <div class="progress-bar" id="progressBar"></div>
      </div>

      <div id="result" class="result"></div>

      <div id="fileList"></div>

      <h3>📋 测试说明</h3>
      <ul>
        <li>
          支持的文件类型：图片 (jpg, png, gif)、文档 (pdf, doc, docx,
          txt)、压缩包 (zip, rar)
        </li>
        <li>文件大小限制：50MB</li>
        <li>上传的文件会保存到服务器的 uploads 目录</li>
        <li>上传成功后可以发送给其他用户</li>
      </ul>

      <h3>🔗 API测试</h3>
      <button onclick="testHealth()">测试后端健康状态</button>
      <button onclick="testAuth()">测试认证状态</button>
      <div id="apiResult"></div>
    </div>

    <script>
      const API_BASE_URL = "http://localhost:3001";
      let selectedFiles = [];

      // 文件选择处理
      document
        .getElementById("fileInput")
        .addEventListener("change", function (e) {
          selectedFiles = Array.from(e.target.files);
          updateFileList();
          updateUploadButton();
        });

      // 拖拽处理
      const uploadArea = document.getElementById("uploadArea");

      uploadArea.addEventListener("dragover", function (e) {
        e.preventDefault();
        uploadArea.classList.add("dragover");
      });

      uploadArea.addEventListener("dragleave", function (e) {
        e.preventDefault();
        uploadArea.classList.remove("dragover");
      });

      uploadArea.addEventListener("drop", function (e) {
        e.preventDefault();
        uploadArea.classList.remove("dragover");
        selectedFiles = Array.from(e.dataTransfer.files);
        updateFileList();
        updateUploadButton();
      });

      function updateFileList() {
        const fileList = document.getElementById("fileList");
        if (selectedFiles.length === 0) {
          fileList.innerHTML = "";
          return;
        }

        let html = "<h3>📄 选择的文件：</h3>";
        selectedFiles.forEach((file, index) => {
          html += `
                    <div class="file-info">
                        <strong>${file.name}</strong><br>
                        大小: ${formatFileSize(file.size)}<br>
                        类型: ${file.type || "未知"}
                        <button onclick="removeFile(${index})" style="float: right; background: #dc3545;">删除</button>
                    </div>
                `;
        });
        fileList.innerHTML = html;
      }

      function removeFile(index) {
        selectedFiles.splice(index, 1);
        updateFileList();
        updateUploadButton();
      }

      function updateUploadButton() {
        const uploadBtn = document.getElementById("uploadBtn");
        uploadBtn.disabled = selectedFiles.length === 0;
      }

      function formatFileSize(bytes) {
        if (bytes === 0) return "0 Bytes";
        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      }

      async function uploadFiles() {
        if (selectedFiles.length === 0) return;

        const resultDiv = document.getElementById("result");
        const progressContainer = document.getElementById("progressContainer");
        const progressBar = document.getElementById("progressBar");
        const uploadBtn = document.getElementById("uploadBtn");

        uploadBtn.disabled = true;
        progressContainer.style.display = "block";
        resultDiv.style.display = "none";

        try {
          for (let i = 0; i < selectedFiles.length; i++) {
            const file = selectedFiles[i];
            const progress = ((i + 1) / selectedFiles.length) * 100;
            progressBar.style.width = progress + "%";

            const formData = new FormData();
            formData.append("file", file);

            const response = await fetch(`${API_BASE_URL}/api/upload/file`, {
              method: "POST",
              headers: {
                Authorization: "Bearer " + getToken(),
              },
              body: formData,
            });

            const result = await response.json();

            if (!response.ok) {
              throw new Error(result.error || "上传失败");
            }

            console.log("上传成功:", result);
          }

          resultDiv.className = "result success";
          resultDiv.innerHTML = `
                    <h4>✅ 上传成功！</h4>
                    <p>已成功上传 ${selectedFiles.length} 个文件</p>
                    <p>文件已保存到服务器，可以在聊天中发送</p>
                `;
          resultDiv.style.display = "block";

          selectedFiles = [];
          updateFileList();
          updateUploadButton();
        } catch (error) {
          console.error("上传失败:", error);
          resultDiv.className = "result error";
          resultDiv.innerHTML = `
                    <h4>❌ 上传失败</h4>
                    <p>错误信息: ${error.message}</p>
                    <p>请检查网络连接和后端服务状态</p>
                `;
          resultDiv.style.display = "block";
        } finally {
          uploadBtn.disabled = false;
          progressContainer.style.display = "none";
          progressBar.style.width = "0%";
        }
      }

      function getToken() {
        // 从localStorage获取token，如果没有则提示登录
        const token = localStorage.getItem("im_token");
        if (!token) {
          alert("请先登录！");
          return null;
        }
        return token;
      }

      async function testHealth() {
        const apiResult = document.getElementById("apiResult");
        try {
          const response = await fetch(`${API_BASE_URL}/health`);
          const result = await response.json();
          apiResult.innerHTML = `
                    <div class="result success">
                        <h4>✅ 后端健康检查通过</h4>
                        <p>状态: ${result.status}</p>
                        <p>运行时间: ${Math.floor(result.uptime)} 秒</p>
                        <p>时间戳: ${result.timestamp}</p>
                    </div>
                `;
        } catch (error) {
          apiResult.innerHTML = `
                    <div class="result error">
                        <h4>❌ 后端连接失败</h4>
                        <p>错误: ${error.message}</p>
                        <p>请确保后端服务正在运行</p>
                    </div>
                `;
        }
      }

      async function testAuth() {
        const apiResult = document.getElementById("apiResult");
        const token = getToken();
        if (!token) return;

        try {
          const response = await fetch(`${API_BASE_URL}/api/user/profile`, {
            headers: {
              Authorization: "Bearer " + token,
            },
          });

          if (response.ok) {
            const result = await response.json();
            apiResult.innerHTML = `
                        <div class="result success">
                            <h4>✅ 认证状态正常</h4>
                            <p>用户: ${result.user.username}</p>
                            <p>邮箱: ${result.user.email || "未设置"}</p>
                        </div>
                    `;
          } else {
            throw new Error("认证失败");
          }
        } catch (error) {
          apiResult.innerHTML = `
                    <div class="result error">
                        <h4>❌ 认证失败</h4>
                        <p>错误: ${error.message}</p>
                        <p>请重新登录</p>
                    </div>
                `;
        }
      }

      // 页面加载时测试后端连接
      window.addEventListener("load", testHealth);
    </script>
  </body>
</html>
